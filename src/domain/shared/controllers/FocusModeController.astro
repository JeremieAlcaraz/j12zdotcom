---
// FocusModeController: handles the global "focus-mode" class.
// Rules:
// - Never persist state (no cookies/storage)
// - Only allow enabling on blog post pages
// - Always reset when navigating away
---

<script is:inline>
  (() => {
    // Detect if current page allows focus mode (blog post layout)
    function isFocusContext() {
      // Presence of the FAB action or the ESC hint marks post pages
      return (
        !!document.querySelector('[data-fab-action="focus"]') ||
        !!document.getElementById('focus-escape-hint')
      )
    }

    function toggleFocus() {
      const willEnable = !document.body.classList.contains('focus-mode')
      // Only allow enabling on post pages; disabling is always allowed
      if (willEnable && !isFocusContext()) return
      document.body.classList.toggle('focus-mode', willEnable)
    }

    // Handle events from the UI FAB (be generous about event shape)
    document.addEventListener('fab:action', (e) => {
      // Access detail safely without instanceof to avoid cross-realm issues
      const detail = (e && (e).detail) || undefined
      const action = detail && detail.action
      if (action === 'focus') toggleFocus()
    })
    
        // Handle Escape key to exit focus mode
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && document.body.classList.contains('focus-mode')) {
            e.preventDefault()
            toggleFocus()
          }
        })

        // Reset on navigations (Astro ViewTransitions)
        document.addEventListener('astro:before-swap', () => {
          // Leaving current page: ensure focus is cleared
          document.body.classList.remove('focus-mode')
        })
        document.addEventListener('astro:page-load', () => {
          // Initial load and after client navigations: ensure focus is cleared
          document.body.classList.remove('focus-mode')
        })
      })()
    </script>
