---
// src/components/contact/ContactForm.astro
// ------------------------------------------------------------------
// Ce composant affiche un formulaire de contact modernisÃ© :
//  â€¢ Layout split (animation + form)
//  â€¢ Glassmorphism & styling premium
//  â€¢ Animation Lottie pour le cÃ´tÃ© "fun"
// ------------------------------------------------------------------

import siteConfig from '@/config/siteConfig.ts'
import AnimatedCat from '@/ui/atoms/AnimatedCat.astro'

// Type Script : les pages peuvent importer ce type si besoin.
export interface ContactFormProps {
  /** Titre H2 au-dessus du formulaire. */
  title?: string
  /** Court texte dâ€™intro / call-to-action. */
  description?: string
}

const { contactFormAction, contactSuccessUrl } = siteConfig.params

const {
  title = 'Fais-moi signe !',
  description = 'Besoin d\'un coup de patte ? Ã‰cris-moi tout ici, mon cha-cteur me l\'apportera en toute douceur ! Et je reviens vers toi aussi rapidement que possible !',
} = Astro.props as ContactFormProps
---

<section id="contact" class="relative overflow-hidden py-16 md:py-24">
  <!-- Background Elements for "Fancy" effect -->
  <div class="absolute -top-24 -left-24 h-96 w-96 rounded-full bg-primary/20 blur-3xl"></div>
  <div class="absolute -bottom-24 -right-24 h-96 w-96 rounded-full bg-secondary/20 blur-3xl"></div>

  <div class="container mx-auto px-4 relative z-10">
    <div class="grid gap-12 lg:grid-cols-2 lg:items-center">
      
      <!-- Left Column: Fun & Animation -->
      <div class="text-center lg:text-left space-y-6">
        <div class="inline-block rounded-full bg-primary/10 px-4 py-1.5 text-sm font-medium text-primary">
          ðŸ‘‹ Discutons ensemble !
        </div>
        <h2 class="text-4xl font-extrabold tracking-tight sm:text-5xl bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
          {title}
        </h2>
        <p class="text-lg md:text-xl font-medium text-base-content/90 max-w-lg mx-auto lg:mx-0 leading-relaxed">
          {description}
        </p>
        
        <!-- Animated Cat -->
        <div class="relative mx-auto lg:mx-0 w-full max-w-[400px] h-[300px]">
           <AnimatedCat />
        </div>
      </div>

      <!-- Right Column: Glassmorphism Form -->
      <div class="card bg-base-100/70 backdrop-blur-md border border-base-content/5 shadow-2xl p-6 md:p-8">
        <form id="contact-form" class="grid gap-5">
          <!-- Anti-spam -->
          <input type="hidden" name="_subject" value={`Nouveau message de ${title}`} />
          <input type="text" name="_gotcha" class="hidden" />

          <div class="grid gap-5 md:grid-cols-2">
            <!-- Champ : PrÃ©nom -->
            <div class="form-control w-full">
              <label class="label" for="firstname">
                <span class="label-text font-medium">Votre prÃ©nom</span>
              </label>
              <input
                id="firstname"
                name="firstname"
                type="text"
                placeholder="John"
                class="input input-bordered w-full bg-base-200/50 focus:bg-base-100 transition-colors"
                required
                autocomplete="given-name"
              />
            </div>

            <!-- Champ : Nom -->
            <div class="form-control w-full">
              <label class="label" for="lastname">
                <span class="label-text font-medium">Votre nom</span>
              </label>
              <input
                id="lastname"
                name="lastname"
                type="text"
                placeholder="Doe"
                class="input input-bordered w-full bg-base-200/50 focus:bg-base-100 transition-colors"
                required
                autocomplete="family-name"
              />
            </div>
          </div>

          <!-- Champ : Email (pleine largeur) -->
          <div class="form-control w-full">
            <label class="label" for="email">
              <span class="label-text font-medium">Votre e-mail</span>
            </label>
            <input
              id="email"
              name="email"
              type="email"
              placeholder="john.doe@example.com"
              class="input input-bordered w-full bg-base-200/50 focus:bg-base-100 transition-colors"
              required
              autocomplete="email"
            />
          </div>

          <!-- Champ : Message -->
          <div class="form-control">
            <label class="label" for="message">
              <span class="label-text font-medium">Votre message</span>
            </label>
            <textarea
              id="message"
              name="message"
              rows="4"
              placeholder="Dites-moi tout..."
              class="textarea textarea-bordered w-full bg-base-200/50 focus:bg-base-100 transition-colors resize-none"
              required></textarea>
          </div>

          <!-- Bouton -->
          <div class="mt-4">
            <button
              type="submit"
              class="btn btn-primary w-full text-lg font-bold shadow-lg shadow-primary/30 hover:shadow-primary/50 hover:-translate-y-1 transition-all duration-300"
            >
              Envoyer le message ðŸš€
            </button>
          </div>
          
          <p class="text-xs text-center text-base-content/50 mt-2">
            Promis, pas de spam. Juste de l'amour. ðŸ’œ
          </p>
        </form>
      </div>
    </div>
  </div>
</section>

<script>
  import siteConfig from '@/config/siteConfig.ts'

  // Messages de validation en franÃ§ais
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('contact-form') as HTMLFormElement
    if (!form) {
      console.error('Formulaire non trouvÃ©')
      return
    }

    const firstname = form.querySelector('#firstname') as HTMLInputElement
    const lastname = form.querySelector('#lastname') as HTMLInputElement
    const email = form.querySelector('#email') as HTMLInputElement
    const message = form.querySelector('#message') as HTMLTextAreaElement
    const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement

    if (!submitButton) {
      console.error('Bouton submit non trouvÃ©')
      return
    }

    console.log('Form handler initialized')

    // PrÃ©nom
    if (firstname) {
      firstname.addEventListener('invalid', (e) => {
        firstname.setCustomValidity('Veuillez renseigner votre prÃ©nom.')
      })
      firstname.addEventListener('input', () => {
        firstname.setCustomValidity('')
      })
    }

    // Nom
    if (lastname) {
      lastname.addEventListener('invalid', (e) => {
        lastname.setCustomValidity('Veuillez renseigner votre nom.')
      })
      lastname.addEventListener('input', () => {
        lastname.setCustomValidity('')
      })
    }

    // Email
    if (email) {
      email.addEventListener('invalid', (e) => {
        if (email.validity.valueMissing) {
          email.setCustomValidity('Veuillez renseigner votre e-mail.')
        } else if (email.validity.typeMismatch) {
          email.setCustomValidity('Veuillez entrer une adresse e-mail valide.')
        }
      })
      email.addEventListener('input', () => {
        email.setCustomValidity('')
      })
    }

    // Message
    if (message) {
      message.addEventListener('invalid', (e) => {
        message.setCustomValidity('Veuillez Ã©crire votre message.')
      })
      message.addEventListener('input', () => {
        message.setCustomValidity('')
      })
    }

    // Interception de la soumission du formulaire
    form.addEventListener('submit', async (e) => {
      console.log('Submit event triggered')
      e.preventDefault()
      console.log('Default prevented')

      // VÃ©rifier si le formulaire est valide
      if (!form.checkValidity()) {
        form.reportValidity()
        return
      }

      // DÃ©sactiver le bouton pendant l'envoi
      const originalText = submitButton.textContent
      submitButton.disabled = true
      submitButton.textContent = 'Envoi en cours...'

      try {
        // RÃ©cupÃ©rer les donnÃ©es du formulaire
        const formData = new FormData(form)

        console.log('Envoi au webhook...')
        // Envoyer au webhook n8n
        const response = await fetch(siteConfig.params.contactFormAction, {
          method: 'POST',
          body: formData,
        })
        console.log('RÃ©ponse reÃ§ue:', response.status)

        // Rediriger vers la page de succÃ¨s quoi qu'il arrive
        // (mÃªme en cas d'erreur, pour ne pas exposer l'URL du webhook)
        console.log('Redirection vers /contact-success/')
        window.location.href = '/contact-success/'
      } catch (error) {
        // En cas d'erreur rÃ©seau, rediriger quand mÃªme vers la page de succÃ¨s
        console.error('Erreur lors de l\'envoi:', error)
        window.location.href = '/contact-success/'
      }
    })
  })
</script>
