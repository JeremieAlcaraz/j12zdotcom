---
import dateFormat from '@/utils/dateFormat'
import { humanize, markdownify, slugify } from '@/utils/textConverter'
import { render } from 'astro:content'
import Avatar from '@/ui/atoms/Avatar.astro'
import Icon from '@/ui/atoms/Icon.astro'
import Accordion from '@/shortcodes/generic/Accordion.shortcode.astro'
import Button from '@/shortcodes/generic/Button.shortcode.astro'
import Notice from '@/shortcodes/generic/Notice.shortcode.astro'
import Video from '@/shortcodes/generic/Video.shortcode.astro'
import Youtube from '@/shortcodes/generic/Youtube.shortcode.astro'
import FabSpeedDial from '@/ui/molecules/FabSpeedDial.astro'
import MusicPlayer from '@/ui/organisms/MusicPlayer.astro'
import FocusEscapeHint from '@/ui/molecules/FocusEscapeHint.astro'

const { post } = Astro.props
const { Content } = await render(post)
const components = { Accordion, Button, Notice, Video, Youtube }
const { title, author, date, tags } = post.data

const formattedAuthor = humanize(author)
const readingTimeDisplay = '4 min read'
const isoDate = date
  ? date instanceof Date
    ? date.toISOString()
    : new Date(date).toISOString()
  : undefined
---

<section class="py-8">
  <article class="prose prose-lg dark:prose-invert mx-auto max-w-3xl">
    <header class="not-prose mb-12 border-b border-base-300 pb-8">
      <h1
        set:html={markdownify(title)}
        class="text-balance text-4xl font-extrabold leading-tight text-base-content sm:text-5xl"
      />

      <div class="mt-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center gap-4">
          <Avatar src="/img_opt/avatar-sm.png" alt={formattedAuthor} size={56} />
          <div class="flex flex-wrap items-center gap-3 text-sm">
            <a
              href="#"
              class="font-medium text-base-content transition hover:text-primary"
            >
              {formattedAuthor}
            </a>
            <button
              type="button"
              class="rounded-full border border-base-300 px-4 py-1 text-sm font-medium text-base-content/80 transition hover:border-base-200 hover:text-base-content"
            >
              Follow
            </button>
            <span class="text-base-content/70">{readingTimeDisplay}</span>
            <span class="text-base-content/50" aria-hidden="true">Â·</span>
            <time datetime={isoDate} class="text-base-content/70">
              {dateFormat(date)}
            </time>
          </div>
        </div>
      </div>

      <div class="mt-8 flex flex-col gap-4 border-t border-base-300 pt-6 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-center gap-6 text-sm text-base-content/80">
          <a href="#" class="flex items-center gap-2 font-medium text-base-content hover:text-primary">
            <Icon name="heroicons:hand-raised" class="size-5" aria-hidden="true" />
            <span class="text-base font-semibold text-base-content">2.8K</span>
          </a>
          <a href="#" class="flex items-center gap-2 font-medium text-base-content hover:text-primary">
            <Icon name="heroicons:chat-bubble-left-right" class="size-5" aria-hidden="true" />
            <span class="text-base font-semibold text-base-content">198</span>
          </a>
        </div>

        <div class="flex items-center gap-2 text-base-content/60">
          <button
            type="button"
            class="rounded-full border border-base-300 p-2 transition hover:border-base-200 hover:text-base-content"
            aria-label="Save"
          >
            <Icon name="heroicons:bookmark" class="size-5" aria-hidden="true" />
          </button>
          <button
            type="button"
            class="rounded-full border border-base-300 p-2 transition hover:border-base-200 hover:text-base-content"
            aria-label="Add to list"
          >
            <Icon name="heroicons:plus" class="size-5" aria-hidden="true" />
          </button>
          <button
            type="button"
            class="rounded-full border border-base-300 p-2 transition hover:border-base-200 hover:text-base-content"
            aria-label="Play"
          >
            <Icon name="heroicons:play" class="size-5" aria-hidden="true" />
          </button>
          <button
            type="button"
            class="rounded-full border border-base-300 p-2 transition hover:border-base-200 hover:text-base-content"
            aria-label="Share"
          >
            <Icon name="heroicons:arrow-up-tray" class="size-5" aria-hidden="true" />
          </button>
          <button
            type="button"
            class="rounded-full border border-base-300 p-2 transition hover:border-base-200 hover:text-base-content"
            aria-label="More options"
          >
            <Icon name="heroicons:ellipsis-horizontal" class="size-5" aria-hidden="true" />
          </button>
        </div>
      </div>
    </header>
    <Content components={components} />
    {
      tags && (
        <div class="not-prose mt-10 flex flex-wrap items-center gap-2">
          <h5 class="mr-2">Tags :</h5>
          <ul class="flex flex-wrap gap-2">
            {tags.map((tag: string) => (
              <li>
                <a
                  class="bg-light hover:bg-primary dark:bg-darkmode-light dark:hover:bg-darkmode-primary m-1 inline-block rounded px-3 py-1 text-sm hover:text-white"
                  href={`/tags/${slugify(tag)}`}
                >
                  {humanize(tag)}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )
    }
  </article>

  <!-- FAB / Speed Dial fixed in the viewport for blog posts -->
  <FabSpeedDial />

  <!-- ESC key hint for focus mode -->
  <FocusEscapeHint />

  <!-- Music dock (toggle with FAB music); only the player itself -->
  <aside id="music-dock" class="music-dock" aria-hidden="true">
    <MusicPlayer />
  </aside>

  <style>
    /* Floating dock positioning + smooth show/hide animation */
    #music-dock.music-dock {
      position: fixed;
      inset-inline-end: 0.5rem; /* stick to the right at ~0.5rem */
      bottom: 12rem; /* 3rem higher above the FAB */
      /* Narrower by an additional 3rem */
      width: min(calc(360px - 5rem), calc(92vw - 5rem));
      z-index: 45; /* below FAB (50), above page */
      opacity: var(--dock-o, 0);
      transform: translate(18px, 14px) scale(0.985);
      transform-origin: 100% 100%; /* animate from bottom-right */
      will-change: transform, opacity;
      pointer-events: none;
      transition: transform 460ms cubic-bezier(0.16, 1, 0.3, 1);
    }
    #music-dock.music-dock.open {
      transform: translate(0, 0) scale(1);
    }
    /* The aside is only a positioning/animation shell */

    @media (prefers-reduced-motion: reduce) {
      #music-dock.music-dock {
        transition: none;
        transform: none;
      }
      #music-dock.music-dock.open {
        opacity: 1;
      }
    }
  </style>

  <script is:inline>
    ;(() => {
      const state = (window.__musicDockState = window.__musicDockState || {
        controller: null,
      })

      if (state.boot) {
        state.boot()
        return
      }

      function destroyController() {
        if (!state.controller) return
        state.controller.destroy()
        state.controller = null
      }

      function setupController(dock) {
        if (!dock) return null

        let isOpen = false
        let inGutter = false
        let target = 0
        let current = 0
        let lastPointerX = null
        let rafId = 0
        let autoHideTimer = 0
        let justOpenedTimer = 0
        let isJustOpened = false
        let lastTs = performance.now()

        const RISE_MS = 800
        const FALL_MS_BASE = 2200
        let effectiveFallMs = FALL_MS_BASE

        let lastScrollY = window.scrollY
        let lastScrollT = performance.now()
        let lastSpeed = 0
        const SPEED_DECAY = 0.92

        function gutterWidth() {
          const vw = window.innerWidth
          return Math.max(120, Math.min(260, Math.round(vw * 0.12)))
        }

        function setPointerEvents() {
          const pe = current > 0.05 && isOpen ? 'auto' : 'none'
          if (dock.style.pointerEvents !== pe) dock.style.pointerEvents = pe
        }

        function setOpacity(val) {
          current = Math.max(0, Math.min(1, val))
          dock.style.setProperty('--dock-o', String(current))
          setPointerEvents()
        }

        function setTarget(val) {
          target = Math.max(0, Math.min(1, val))
          if (!rafId) rafId = requestAnimationFrame(tick)
        }

        function clearAutoHide() {
          if (autoHideTimer) {
            clearTimeout(autoHideTimer)
            autoHideTimer = 0
          }
        }

        function scheduleAutoHide(delay = 0) {
          clearAutoHide()
          if (!isOpen || inGutter) return
          autoHideTimer = window.setTimeout(() => {
            autoHideTimer = 0
            if (!isOpen || inGutter) return
            setTarget(0)
          }, Math.max(0, delay))
        }

        function computeFallMs() {
          const factor = 1 + 0.003 * lastSpeed
          effectiveFallMs = Math.max(300, Math.round(FALL_MS_BASE / factor))
        }

        function tick(ts) {
          const dt = Math.max(0, (ts || performance.now()) - lastTs)
          lastTs = ts || performance.now()

          lastSpeed *= SPEED_DECAY
          computeFallMs()

          const duration = target > current ? RISE_MS : effectiveFallMs
          if (duration <= 0) {
            setOpacity(target)
          } else {
            const step = dt / duration
            const next = current + (target - current) * Math.min(1, step)
            setOpacity(next)
          }

          if (Math.abs(target - current) > 0.003) {
            rafId = requestAnimationFrame(tick)
          } else {
            rafId = 0
            setOpacity(target)
          }
        }

        function computeInGutter(x) {
          if (typeof x !== 'number' || Number.isNaN(x)) return false
          const w = gutterWidth()
          return x >= window.innerWidth - w
        }

        function syncInGutter(x = lastPointerX) {
          const next = computeInGutter(x)
          const changed = next !== inGutter
          inGutter = next
          return changed
        }

        function updateInGutterFromPointer(e) {
          if (typeof e?.clientX !== 'number') return
          lastPointerX = e.clientX
          const changed = syncInGutter(lastPointerX)
          if (!isOpen || isJustOpened) return
          if (inGutter) {
            clearAutoHide()
            setTarget(1)
          } else {
            if (changed) setTarget(0)
            scheduleAutoHide()
          }
        }

        function handleScroll() {
          const now = performance.now()
          const dy = Math.abs(window.scrollY - lastScrollY)
          const dt = Math.max(16, now - lastScrollT)
          lastScrollY = window.scrollY
          lastScrollT = now
          lastSpeed = (dy / dt) * 1000
          if (isOpen && !inGutter) {
            setTarget(0)
            scheduleAutoHide()
          }
        }

        function handleResize() {
          syncInGutter()
          if (isOpen) setTarget(inGutter ? 1 : 0)
          if (!inGutter) scheduleAutoHide()
        }

        const setOpen = (v, opts = {}) => {
          const { immediate = false, forceReveal = false } = opts
          isOpen = !!v
          dock.classList.toggle('open', isOpen)
          dock.setAttribute('aria-hidden', isOpen ? 'false' : 'true')
          if (isOpen) {
            syncInGutter()
            const targetValue = forceReveal ? 1 : inGutter ? 1 : 0
            setTarget(targetValue)
            if (inGutter) clearAutoHide()
            else scheduleAutoHide(forceReveal ? 600 : 0)
            isJustOpened = true
            if (justOpenedTimer) clearTimeout(justOpenedTimer)
            justOpenedTimer = setTimeout(() => {
              isJustOpened = false
            }, 400)
          } else {
            isJustOpened = false
            if (justOpenedTimer) {
              clearTimeout(justOpenedTimer)
              justOpenedTimer = 0
            }
            if (immediate) {
              if (rafId) {
                cancelAnimationFrame(rafId)
                rafId = 0
              }
              setOpacity(0)
            } else {
              setTarget(0)
            }
            clearAutoHide()
          }
        }

        const toggle = opts => setOpen(!isOpen, opts)

        const onFabAction = e => {
          const action = e?.detail?.action
          if (action === 'music') {
            if (isOpen) toggle({ immediate: true })
            else toggle({ forceReveal: true })
          }
        }

        const onKeydown = e => {
          if (e.key === 'Escape' && isOpen) setOpen(false)
        }

        document.addEventListener('fab:action', onFabAction)
        document.addEventListener('keydown', onKeydown)
        document.addEventListener('mousemove', updateInGutterFromPointer)
        document.addEventListener('mousedown', updateInGutterFromPointer)
        document.addEventListener('scroll', handleScroll, { passive: true })
        window.addEventListener('resize', handleResize)

        setOpacity(0)

        return {
          destroy() {
            document.removeEventListener('fab:action', onFabAction)
            document.removeEventListener('keydown', onKeydown)
            document.removeEventListener('mousemove', updateInGutterFromPointer)
            document.removeEventListener('mousedown', updateInGutterFromPointer)
            document.removeEventListener('scroll', handleScroll)
            window.removeEventListener('resize', handleResize)
            clearAutoHide()
            if (justOpenedTimer) {
              clearTimeout(justOpenedTimer)
              justOpenedTimer = 0
            }
            if (rafId) {
              cancelAnimationFrame(rafId)
              rafId = 0
            }
            isOpen = false
            dock.classList.remove('open')
            dock.setAttribute('aria-hidden', 'true')
            dock.style.pointerEvents = 'none'
            dock.style.setProperty('--dock-o', '0')
          },
        }
      }

      function initController() {
        const dock = document.getElementById('music-dock')
        if (!dock) return
        if (state.controller && state.controller.dock === dock) return
        destroyController()
        const controller = setupController(dock)
        if (controller) {
          state.controller = { ...controller, dock }
        }
      }

      const boot = () => {
        requestAnimationFrame(() => {
          initController()
        })
      }

      state.boot = boot
      state.destroy = destroyController

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', boot, { once: true })
      } else {
        boot()
      }

      document.addEventListener('astro:page-load', boot)
      document.addEventListener('astro:after-swap', boot)
      document.addEventListener('astro:before-swap', destroyController)
    })()
  </script>

  <!-- Enable entering focus mode with Enter on blog posts -->
  <script is:inline>
    ;(() => {
      const state = (window.__focusEnterShortcut = window.__focusEnterShortcut || {
        attached: false,
      })

      function isPageContext() {
        return !!document.querySelector('[data-fab-action="focus"]')
      }

      function onKeydown(e) {
        if (e.key !== 'Enter') return
        if (!state.attached) return
        const active = document.activeElement
        const pageFocused = !active || active === document.body || active === document.documentElement
        if (!pageFocused) return
        if (document.body.classList.contains('focus-mode')) return
        if (e.altKey || e.ctrlKey || e.metaKey || e.shiftKey) return
        e.preventDefault()
        const ev = new CustomEvent('fab:action', {
          detail: { action: 'focus' },
          bubbles: true,
          composed: true,
        })
        document.dispatchEvent(ev)
      }

      function attach() {
        if (state.attached || !isPageContext()) return
        document.addEventListener('keydown', onKeydown)
        state.attached = true
      }

      function detach() {
        if (!state.attached) return
        document.removeEventListener('keydown', onKeydown)
        state.attached = false
      }

      attach()

      document.addEventListener('astro:before-swap', detach)
      document.addEventListener('astro:page-load', () => {
        requestAnimationFrame(() => {
          if (!isPageContext()) {
            detach()
            return
          }
          attach()
        })
      })
    })()
  </script>
</section>
