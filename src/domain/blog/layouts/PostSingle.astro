---
import dateFormat from '@/utils/dateFormat'
import { humanize, markdownify, slugify } from '@/utils/textConverter'
import { render } from 'astro:content'
import { FaRegClock, FaRegFolder, FaRegUserCircle } from 'react-icons/fa'
import ImageMod from '@/ui/atoms/ImageMod.astro'
import Accordion from '@/shortcodes/generic/Accordion.shortcode.astro'
import Button from '@/shortcodes/generic/Button.shortcode.astro'
import Notice from '@/shortcodes/generic/Notice.shortcode.astro'
import Video from '@/shortcodes/generic/Video.shortcode.astro'
import Youtube from '@/shortcodes/generic/Youtube.shortcode.astro'
import FabSpeedDial from '@/ui/molecules/FabSpeedDial.astro'
import MusicPlayer from '@/ui/molecules/MusicPlayer.astro'
import FocusEscapeHint from '@/ui/molecules/FocusEscapeHint.astro'

const { post } = Astro.props
const { Content } = await render(post)
const components = { Accordion, Button, Notice, Video, Youtube }
const { title, author, categories, image, date, tags } = post.data
---

<section class="py-8">
  <article class="prose prose-lg dark:prose-invert mx-auto max-w-3xl">
    {
      image && (
        <figure class="not-prose mb-8">
          <ImageMod
            src={image}
            height={500}
            width={1200}
            alt={title}
            class="w-full rounded"
            format="webp"
          />
        </figure>
      )
    }
    <header class="not-prose mb-8">
      <h1 set:html={markdownify(title)} class="mb-4" />
      <ul class="flex flex-wrap items-center gap-x-4 text-sm text-gray-600 dark:text-gray-400">
        <li class="flex items-center">
          <FaRegUserCircle className={'-mt-0.5 mr-2 inline-block'} />
          <a href={`/authors/${slugify(author)}`}>{humanize(author)}</a>
        </li>
        <li class="flex items-center">
          <FaRegFolder className={'-mt-0.5 mr-2 inline-block'} />
          {
            categories.map((category: string, index: number) => (
              <a href={`/categories/${slugify(category)}`}>
                {humanize(category)}
                {index !== categories.length - 1 && ','}
              </a>
            ))
          }
        </li>
        <li class="flex items-center">
          <FaRegClock className={'-mt-0.5 mr-2 inline-block'} />
          {dateFormat(date)}
        </li>
      </ul>
    </header>
    <Content components={components} />
    {
      tags && (
        <div class="not-prose mt-10 flex flex-wrap items-center gap-2">
          <h5 class="mr-2">Tags :</h5>
          <ul class="flex flex-wrap gap-2">
            {tags.map((tag: string) => (
              <li>
                <a
                  class="bg-light hover:bg-primary dark:bg-darkmode-light dark:hover:bg-darkmode-primary m-1 inline-block rounded px-3 py-1 text-sm hover:text-white"
                  href={`/tags/${slugify(tag)}`}
                >
                  {humanize(tag)}
                </a>
              </li>
            ))}
          </ul>
        </div>
      )
    }
  </article>

  <!-- FAB / Speed Dial fixed in the viewport for blog posts -->
  <FabSpeedDial />
  
  <!-- ESC key hint for focus mode -->
  <FocusEscapeHint />

  <!-- Music dock (appears when clicking the music FAB item) -->
  <aside id="music-dock" class="music-dock" aria-hidden="true">
    <div class="music-panel bg-base-100/80 border-2 border-violet-500/70 shadow-2xl rounded-2xl backdrop-blur-md">
      <div class="flex items-center justify-between gap-2 px-2 pt-2 pb-1 select-none">
        <button type="button" data-drag-handle title="DÃ©placer" class="btn btn-ghost btn-xs text-base-content/70">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5">
            <path d="M10 3h4v4h-4V3Zm0 7h4v4h-4v-4Zm0 7h4v4h-4v-4Z"/>
          </svg>
        </button>
        <button type="button" id="music-dock-close" class="btn btn-circle btn-ghost btn-sm" aria-label="Fermer le lecteur">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-5">
            <path fill-rule="evenodd" d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>
      <div class="p-3">
        <MusicPlayer />
      </div>
    </div>
  </aside>

  <style>
    /* Floating dock positioning + smooth show/hide animation */
    #music-dock.music-dock {
      position: fixed;
      inset-inline-end: 1rem; /* stick to the right at ~1rem */
      bottom: 9rem; /* sit nicely above the FAB */
      width: min(360px, 92vw);
      z-index: 45; /* below FAB (50), above page */
      opacity: 0;
      transform: translate(18px, 14px) scale(0.985);
      transform-origin: 100% 100%; /* animate from bottom-right */
      will-change: transform, opacity;
      pointer-events: none;
      transition: opacity 420ms cubic-bezier(0.16, 1, 0.3, 1),
                  transform 460ms cubic-bezier(0.16, 1, 0.3, 1);
    }
    /* Dragging helpers */
    #music-dock [data-drag-handle] { cursor: grab; }
    #music-dock.dragging [data-drag-handle] { cursor: grabbing; }
    #music-dock.dragging .music-panel { user-select: none; }
    #music-dock.music-dock.open {
      opacity: 1;
      transform: translate(0, 0) scale(1);
      pointer-events: auto;
    }
    #music-dock .music-panel { overflow: hidden; }

    @media (prefers-reduced-motion: reduce) {
      #music-dock.music-dock { transition: none; transform: none; }
      #music-dock.music-dock.open { opacity: 1; }
    }
  </style>

  <script is:inline>
    (() => {
      const dock = document.getElementById('music-dock')
      const closeBtn = document.getElementById('music-dock-close')
      const handle = dock?.querySelector('[data-drag-handle]')
      if (!dock) return
      let isOpen = false
      const POS_KEY = 'music-dock-pos'
      const setOpen = (v) => {
        isOpen = !!v
        dock.classList.toggle('open', isOpen)
        dock.setAttribute('aria-hidden', isOpen ? 'false' : 'true')
      }
      const toggle = () => setOpen(!isOpen)

      function onFabAction(e) {
        const action = e?.detail?.action
        if (action === 'music') {
          toggle()
        }
      }
      function onKeydown(e) {
        if (e.key === 'Escape' && isOpen) setOpen(false)
      }

      const onCloseClick = () => setOpen(false)
      document.addEventListener('fab:action', onFabAction)
      document.addEventListener('keydown', onKeydown)
      closeBtn?.addEventListener('click', onCloseClick)

      // Cleanup on navigation (Astro ViewTransitions)
      document.addEventListener('astro:before-swap', () => {
        document.removeEventListener('fab:action', onFabAction)
        document.removeEventListener('keydown', onKeydown)
        closeBtn?.removeEventListener('click', onCloseClick)
      })

      // --- Drag to move ----------------------------------------------------
      let dragging = false
      let offsetX = 0
      let offsetY = 0

      function clamp(value, min, max) {
        return Math.max(min, Math.min(max, value))
      }

      function applyManualPosition(left, top) {
        dock.style.left = `${left}px`
        dock.style.top = `${top}px`
        dock.style.right = 'auto'
        dock.style.bottom = 'auto'
      }

      function savePosition(left, top) {
        try { localStorage.setItem(POS_KEY, JSON.stringify({ left, top })) } catch (_) {}
      }

      function restorePosition() {
        try {
          const raw = localStorage.getItem(POS_KEY)
          if (!raw) return
          const pos = JSON.parse(raw)
          if (typeof pos?.left === 'number' && typeof pos?.top === 'number') {
            const vw = window.innerWidth
            const vh = window.innerHeight
            const rect = dock.getBoundingClientRect()
            const maxLeft = vw - rect.width - 8
            const maxTop = vh - rect.height - 8
            const left = clamp(pos.left, 8, Math.max(8, maxLeft))
            const top = clamp(pos.top, 8, Math.max(8, maxTop))
            applyManualPosition(left, top)
          }
        } catch (_) {}
      }

      function onPointerDown(e) {
        if (e.button !== 0) return
        dock.classList.add('dragging')
        dragging = true
        const rect = dock.getBoundingClientRect()
        // If dock is positioned via right/bottom, switch to left/top once
        applyManualPosition(rect.left, rect.top)
        offsetX = e.clientX - rect.left
        offsetY = e.clientY - rect.top
        window.addEventListener('pointermove', onPointerMove)
        window.addEventListener('pointerup', onPointerUp, { once: true })
      }

      function onPointerMove(e) {
        if (!dragging) return
        const vw = window.innerWidth
        const vh = window.innerHeight
        const rect = dock.getBoundingClientRect()
        let left = e.clientX - offsetX
        let top = e.clientY - offsetY
        const maxLeft = vw - rect.width - 8
        const maxTop = vh - rect.height - 8
        left = clamp(left, 8, Math.max(8, maxLeft))
        top = clamp(top, 8, Math.max(8, maxTop))
        applyManualPosition(left, top)
      }

      function onPointerUp() {
        if (!dragging) return
        dragging = false
        dock.classList.remove('dragging')
        const rect = dock.getBoundingClientRect()
        savePosition(rect.left, rect.top)
        window.removeEventListener('pointermove', onPointerMove)
      }

      handle?.addEventListener('pointerdown', onPointerDown)
      restorePosition()
    })()
  </script>

  <!-- Enable entering focus mode with Enter on blog posts -->
  <script is:inline>
    (() => {
      // Only active on this page; detach on navigation
      function onKeydown(e) {
        if (e.key !== 'Enter') return
        // Only when the page itself is focused (avoid links/forms)
        const active = document.activeElement
        const pageFocused = !active || active === document.body
        if (!pageFocused) return
        if (document.body.classList.contains('focus-mode')) return
        if (e.altKey || e.ctrlKey || e.metaKey || e.shiftKey) return
        e.preventDefault()
        const ev = new CustomEvent('fab:action', {
          detail: { action: 'focus' },
          bubbles: true,
          composed: true,
        })
        document.dispatchEvent(ev)
      }

      document.addEventListener('keydown', onKeydown)
      // Clean up when navigating away (Astro ViewTransitions)
      document.addEventListener('astro:before-swap', () => {
        document.removeEventListener('keydown', onKeydown)
      })
    })()
  </script>
</section>
