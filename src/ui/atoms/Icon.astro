---
/**
 * Icon.astro
 * - Custom locaux (src/assets/icons/*.svg)
 * - Icônes externes via registre TS (src/ui/icons/icon-registry.ts)
 */
import { ICONS, PREFIX_ALIASES, normalizeIconName, toIconifyName } from '../icons/icon-registry'
import { Icon as AIcon } from 'astro-icon/components'

// Custom locaux (glob au build, zéro JS côté client)
const modules = import.meta.glob('@/assets/icons/*.svg', { eager: true }) as Record<string, any>
const customRegistry = Object.fromEntries(
  Object.entries(modules).map(([path, mod]) => [path.split('/').pop()!.replace('.svg', ''), mod.default]),
)

interface Props {
  name: string
  size?: number | string
  title?: string
  class?: string
  id?: string
}

const { name, size = 24, title, class: klass = '', id, ...rest } = Astro.props as Props & Record<string, unknown>

// Analyse "prefix:icon" avec normalisation conviviale
let prefix = 'custom'
let icon = name
const normalizedInput = normalizeIconName(name)
if (normalizedInput.includes(':')) {
  const [p, n] = normalizedInput.split(':')
  prefix = p
  icon = n
}

// Normalise préfixes (aliases)
const norm = PREFIX_ALIASES[prefix] ?? prefix
const key = norm === 'custom' ? icon : `${norm}:${icon}`

// Résolution
let IconComponent = norm === 'custom' ? customRegistry[icon] : ICONS[key]
if (!IconComponent) console.warn(`[Icon] Icône non trouvée: ${key}`)

// 1) Si l'appelant fournit size-*/w-*/h-*, on laisse Tailwind piloter la taille
const hasSizeClass = /\b(size-|w-|h-)/.test(klass)

// 2) Inline style seulement si aucune classe de taille n'est donnée
const style = hasSizeClass
  ? undefined
  : (typeof size === 'number'
      ? `width:${size}px;height:${size}px;`
      : `width:${size};height:${size};`)

// 3) L’SVG interne occupe toute la place du conteneur quand on utilise des classes de taille
const svgSizingClass = hasSizeClass ? 'block w-full h-full' : 'block'
---

{IconComponent ? (
  <span
    class:list={['inline-block align-middle', klass]}
    style={style}
    role={title ? 'img' : 'presentation'}
    aria-label={title || undefined}
    {...(id && { id })}
    {...rest}
  >
    <IconComponent class={svgSizingClass} />
  </span>
) : (
  <span
    class:list={['inline-block align-middle', klass]}
    style={style}
    role={title ? 'img' : 'presentation'}
    aria-label={title || undefined}
    {...(id && { id })}
    {...rest}
  >
    <AIcon name={toIconifyName(`${prefix}:${icon}`)} class={svgSizingClass} />
  </span>
)}
