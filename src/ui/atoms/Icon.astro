---
/**
 * Icon.astro
 * - Custom locaux (src/assets/icons/*.svg)
 * - Icônes externes via registre TS (src/ui/icons/icon-registry.ts)
 */
import { ICONS, PREFIX_ALIASES } from '../icons/icon-registry'

// Custom locaux (glob au build, zéro JS côté client)
const modules = import.meta.glob('@/assets/icons/*.svg', { eager: true }) as Record<string, any>
const customRegistry = Object.fromEntries(
  Object.entries(modules).map(([path, mod]) => [path.split('/').pop()!.replace('.svg', ''), mod.default]),
)

interface Props {
  name: string
  size?: number | string
  title?: string
  class?: string
  id?: string
}

const { name, size = 24, title, class: klass, id, ...rest } = Astro.props as Props & Record<string, unknown>

// Analyse "prefix:icon"
let prefix = 'custom'
let icon = name
if (name.includes(':')) {
  const [p, n] = name.split(':')
  prefix = p
  icon = n
}

// Normalise préfixes (aliases)
const norm = PREFIX_ALIASES[prefix] ?? prefix
const key = norm === 'custom' ? icon : `${norm}:${icon}`

// Résolution
let IconComponent = norm === 'custom' ? customRegistry[icon] : ICONS[key]
if (!IconComponent) console.warn(`[Icon] Icône non trouvée: ${key}`)

// Styles de taille
const style =
  typeof size === 'number' ? `width:${size}px;height:${size}px;` : `width:${size};height:${size};`
---

{IconComponent ? (
  <span
    class:list={['inline-block align-middle', klass]}
    style={style}
    role={title ? 'img' : 'presentation'}
    aria-label={title || undefined}
    {...(id && { id })}
    {...rest}
  >
    <IconComponent />
  </span>
) : (
  <span class="inline-block h-[1em] w-[1em]" aria-hidden="true" />
)}