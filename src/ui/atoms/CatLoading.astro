---
import { Image } from 'astro:assets'
import logo from '@/assets/logos/logo.svg'
---

<div class="wrapper-cat-loading" id="cat-loading-wrapper">
  <!-- Logo fixe qui apparaît après l'animation -->
  <div class="logo-fixed">
    <Image src={logo} alt="Logo" class="logo-image" />
    <span class="logo-text">Jeremie Alcaraz</span>
  </div>

  <div class="animation-wrapper">
    <div class="cat-wrapper">
      <svg
        class="cat"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 207.68 163.77"
        preserveAspectRatio="none"
      >
        <title>cat</title>
        <g class="body">
          <circle class="body-backcircle" cx="76.86" cy="83.31" r="45.5"></circle>
          <circle class="body-frontcircle" cx="150.86" cy="83.31" r="45.5"></circle>
          <rect class="body-between" x="74.65" y="37.89" width="83.04" height="90.61"></rect>
        </g>
        <circle class="head" cx="161.76" cy="52.75" r="45.92"></circle>
        <g class="eyes">
          <circle class="eyes-l" cx="153.51" cy="46.5" r="8.25"></circle>
          <circle class="eyes-r" cx="185.76" cy="46.5" r="8.25"></circle>
        </g>
        <g class="ears">
          <polygon class="ears-l" points="132.76 19 132.76 0 149.55 8.81 132.76 19"></polygon>
          <polygon class="ears-r" points="179.44 11.2 197 4.06 195.16 22.9 179.44 11.2"></polygon>
        </g>
        <rect
          class="tail"
          x="-11"
          y="32.87"
          width="107"
          height="20"
          rx="9.58"
          ry="9.58"
          transform="translate(41.19 -18.41) rotate(45)"></rect>
        <g class="backlegs">
          <path
            class="backlegs1"
            d="M74,124.85a6,6,0,0,0-4.7-7.07l-4.41-.89a6,6,0,0,0-7.07,4.7l-6.31,31.35a8.25,8.25,0,1,0,15.64,5,5.94,5.94,0,0,0,.44-1.33Z"
            transform="translate(-1.58 -0.92)"></path>
          <path
            class="backlegs2"
            d="M88.22,125.86a6,6,0,0,0-4.38-7.27l-4.37-1.08a6,6,0,0,0-7.27,4.38l-7.69,31a8.25,8.25,0,1,0,15.41,5.72,5.94,5.94,0,0,0,.5-1.31Z"
            transform="translate(-1.58 -0.92)"></path>
        </g>
        <g class="frontlegs">
          <path
            class="frontlegs1"
            d="M162.89,120.91a6,6,0,0,0-7.65-3.68L151,118.72a6,6,0,0,0-3.68,7.65l10.57,30.18a8.25,8.25,0,1,0,16-3.65,5.94,5.94,0,0,0-.3-1.37Z"
            transform="translate(-1.58 -0.92)"></path>
          <path
            class="frontlegs2"
            d="M175.77,120.08a6,6,0,0,0-7.48-4l-4.31,1.3a6,6,0,0,0-4,7.48l9.22,30.62a8.25,8.25,0,1,0,16.17-2.94,5.94,5.94,0,0,0-.24-1.38Z"
            transform="translate(-1.58 -0.92)"></path>
        </g>
      </svg>
    </div>
    <div class="logoani">
      <Image src={logo} alt="Logo" class="logo-image-ani" />
      <span class="logo-text">Jeremie Alcaraz</span>
    </div>
  </div>
</div>

<style>
  .wrapper-cat-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: oklch(var(--b1));
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  /* Cacher l'animation si elle a déjà été vue (via classe sur html) */
  :global(html.cat-seen) .wrapper-cat-loading {
    display: none !important;
  }

  /* Cacher tout le contenu du site SAUF le loader tant que l'animation n'est pas vue */
  :global(html:not(.cat-seen) body > *:not(.wrapper-cat-loading)) {
    display: none !important;
  }

  .animation-wrapper {
    display: flex;
  }

  .cat {
    width: 80%;
    overflow: visible;
  }

  .cat-wrapper {
    width: 300px;
  }

  .eyes circle {
    fill: #fff;
  }

  .frontlegs,
  .backlegs {
    opacity: 1;
  }

  .logoani {
    align-self: flex-end;
    margin-left: -25px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .logo-fixed {
    position: absolute;
    top: -40px;
    opacity: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .logo-fixed.visible {
    opacity: 1;
    top: 40px;
    transition: all 1s;
  }

  .logo-image,
  .logo-image-ani {
    height: 2.5rem;
    width: auto;
  }

  .logo-text {
    font-size: 1.5rem;
    font-weight: 700;
    color: oklch(var(--bc));
    font-family: system-ui, -apple-system, sans-serif;
  }

  /* Couleurs du chat basées sur le thème */
  .body-backcircle,
  .body-frontcircle,
  .body-between,
  .head,
  .ears-l,
  .ears-r,
  .tail,
  .backlegs1,
  .backlegs2,
  .frontlegs1,
  .frontlegs2 {
    fill: oklch(var(--p));
  }
</style>

<script>
  import { gsap } from 'gsap'

  document.addEventListener('astro:page-load', () => {
    // Si l'animation a déjà été vue, ne rien faire (le CSS gère le masquage)
    if (document.documentElement.classList.contains('cat-seen')) {
      return
    }

    const wrapper = document.querySelector('.wrapper-cat-loading') as HTMLElement | null
    if (!wrapper) return

    const cat = wrapper.querySelector('.cat')
    const head = wrapper.querySelector('.head')
    const eyes = wrapper.querySelectorAll('.eyes circle')
    const eyel = wrapper.querySelectorAll('.eyes-l')
    const eyer = wrapper.querySelectorAll('.eyes-r')
    const ears = wrapper.querySelectorAll('.ears')
    const earsl = wrapper.querySelector('.ears-l')
    const earsr = wrapper.querySelector('.ears-r')
    const tail = wrapper.querySelector('.tail')
    const backlegs = wrapper.querySelector('.backlegs')
    const frontlegs = wrapper.querySelector('.frontlegs')
    const frontlegs1 = wrapper.querySelector('.frontlegs1')
    const backcircle = wrapper.querySelector('.body-backcircle')
    const frontcircle = wrapper.querySelector('.body-frontcircle')
    const bodybetween = wrapper.querySelector('.body-between')
    const logo = wrapper.querySelector('.logoani')
    const logofix = wrapper.querySelector('.logo-fixed')

    function initAni() {
      const tl = gsap.timeline({ delay: 0.5, onComplete: finishAnimation })
      const tl_eye = gsap.timeline({ delay: 1.5, repeat: 3, repeatDelay: 1 })

      // Reset positions
      gsap.set([head, eyes, ears], { y: 20, x: 30 })
      gsap.set(backcircle, { y: 35, x: 40 })
      gsap.set(cat, { opacity: 1 })
      gsap.set(bodybetween, { scaleX: 0.5, y: 35, x: 45, rotation: 0 })
      gsap.set(frontcircle, { y: 35, x: 10 })
      gsap.set(head, { y: 20 })
      gsap.set(eyel, { scaleY: 1 })
      gsap.set(eyer, { scaleY: 1 })
      gsap.set(ears, { y: 20 })
      gsap.set(tail, { y: 110, x: 30, rotation: 0 })
      gsap.set(backlegs, { rotation: -100, y: 55, x: 50 })
      gsap.set(frontlegs, { y: 0, x: 0, rotation: 0 })
      gsap.set(logo, { opacity: 1, x: 0, y: 0, rotation: 0 })
      gsap.set(earsl, { x: 0, y: 0, rotation: 0 })
      gsap.set(earsr, { x: 0, y: 0, rotation: 0 })

      tl.to([head, eyes, ears], { duration: 0.2, y: 45, x: 30 })
        .addLabel('twink')
        .to(eyel, { duration: 0.1, scaleY: 1, y: 45 }, 'twink-=0.1')
        .to(eyel, { duration: 0.1, scaleY: 0.1, y: 55 }, 'twink')
        .to(eyel, { duration: 0.1, scaleY: 1, y: 45 }, 'twink +=0.1')
        .to(eyer, { duration: 0.1, scaleY: 0.1, y: 55 }, 'twink')
        .to(eyer, { duration: 0.1, scaleY: 1, y: 45 }, 'twink +=0.1')
        .to(earsl, { duration: 0.1, y: 8, x: -5, rotation: -20 }, 'twink +=0.1')
        .to(earsr, { duration: 0.1, y: 16, x: -15, rotation: -60 }, 'twink +=0.1')
        .set(frontlegs, { opacity: 1 }, '+=0.5')
        .to(frontlegs1, { duration: 0.1, y: 35, x: 15, rotation: -60 })
        .to(logo, { duration: 0.1, x: 5 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: 5, rotation: -60 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: 15, rotation: -60 })
        .to(logo, { duration: 0.3, x: 10 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: -5, rotation: -60 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: 25, rotation: -60 }, '+=0.5')
        .to(logo, { duration: 0.1, x: 12 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: 5, rotation: -60 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: 25, rotation: -60 })
        .to(logo, { duration: 0.3, x: 17 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: -5, rotation: -60 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: 35, rotation: -60 })
        .to(logo, { duration: 0.1, x: 20 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: -5, rotation: -60 })
        .to(frontlegs1, { duration: 0.1, y: 30, x: 30, rotation: -60, scaleY: 1.2 })
        .to(logo, { duration: 0.5, x: 30 })
        .to(logo, { duration: 0.1, rotation: 10 })
        .to(frontlegs1, { duration: 0.1, y: 35, x: -15, rotation: -60, scaleY: 1 })
        .addLabel('wiggle')
        .to([head, eyes, ears], { duration: 0.1, y: 48 }, 'wiggle')
        .to(earsl, { duration: 0.1, y: 10, x: -5, rotation: -20 }, 'wiggle')
        .to(earsr, { duration: 0.1, y: 18, x: -15, rotation: -60 }, 'wiggle')
        .to(backcircle, { duration: 0.1, y: 30, x: 40 }, 'wiggle =-0.2')
        .to(backcircle, { duration: 0.1, y: 30, x: 37 }, 'wiggle =-0.1')
        .to(backcircle, { duration: 0.1, y: 35, x: 40 }, 'wiggle')
        .to(backcircle, { duration: 0.1, y: 30, x: 40 })
        .to(backcircle, { duration: 0.1, y: 30, x: 37 })
        .to(backcircle, { duration: 0.1, y: 35, x: 40 })
        .to(backcircle, { duration: 0.1, y: 30, x: 40 })
        .to(backcircle, { duration: 0.1, y: 30, x: 37 })
        .to(backcircle, { duration: 0.1, y: 35, x: 40 })
        .addLabel('logowiggle')
        .to(
          frontlegs1,
          { duration: 0.1, y: 35, x: 30, rotation: -60, scaleY: 1.25 },
          'logowiggle-=0.1'
        )
        .to(logo, { duration: 0.1, rotation: 60, x: 70 }, 'logowiggle')
        .to(logo, { duration: 0.5, y: 50 }, 'logowiggle+=0.1')
        .to(logo, { duration: 0.1, rotation: 120 }, 'logowiggle+=0.1')
        .to(logo, { duration: 0.1, rotation: 270 }, 'logowiggle+=0.2')
        .to(logo, { duration: 0.5, y: 550, x: 90 }, 'logowiggle+=0.2')
        .to(logo, { duration: 0.5, opacity: 0 }, 'logowiggle')
        .to(frontlegs1, { duration: 0.1, y: 35, x: -15, rotation: -60, scaleY: 1 })
        .addLabel('jump')
        .to([head, eyes, ears], { duration: 0.1, y: 5 }, 'jump')
        .to(frontcircle, { duration: 0.1, y: 15, x: 5 }, 'jump')
        .to(bodybetween, { duration: 0.1, rotation: -25, x: 25, y: 38 }, 'jump')
        .to(frontlegs1, { duration: 0.1, y: 0, x: 0, rotation: 0 }, 'jump')
        .to(tail, { duration: 0.1, y: 115, x: 20, rotation: -10 }, 'jump')
        .to(frontlegs, { duration: 0.1, y: -20 }, 'jump+=0.1')

        .to([head, eyes, ears, frontcircle], { duration: 0.1, x: 75, y: 5 }, 'jump+=0.2')
        .to(frontcircle, { duration: 0.1, x: 55, y: 5 }, 'jump+=0.2')
        .to(
          bodybetween,
          { duration: 0.1, scaleX: 1, x: 45, y: 25, rotation: -15 },
          'jump+=0.2'
        )
        .to(backcircle, { duration: 0.1, x: 50, y: 25 }, 'jump+=0.2')
        .to(backlegs, { duration: 0.1, x: 70 }, 'jump+=0.2')

        .to(frontlegs, { duration: 0.1, x: 250, y: 5, rotation: -45 }, 'jump+=0.3')
        .to(frontcircle, { duration: 0.1, x: 250 }, 'jump+=0.3')
        .to(backcircle, { duration: 0.1, y: 0, x: 250 }, 'jump+=0.3')
        .to(
          bodybetween,
          { duration: 0.1, y: 0, x: 255, scaleX: 1, rotation: 4 },
          'jump+=0.3'
        )
        .to([head, eyes, ears], { duration: 0.1, x: 275 }, 'jump+=0.3')
        .to(tail, { duration: 0.1, y: 25, x: 230, rotation: 15 }, 'jump+=0.3')
        .to(backlegs, { duration: 0.1, rotation: 45, x: 250, y: -25 }, 'jump+=0.3')

        .to(frontlegs, { duration: 0.1, x: 340, y: 105, rotation: -15 }, 'jump+=0.4')
        .to(frontcircle, { duration: 0.1, x: 340, y: 105 }, 'jump+=0.4')
        .to(backcircle, { duration: 0.1, y: 60, x: 350 }, 'jump+=0.4')
        .to(
          bodybetween,
          { duration: 0.1, y: 70, x: 380, scaleX: 1, rotation: 35 },
          'jump+=0.4'
        )
        .to([head, eyes, ears], { duration: 0.1, x: 385, y: 125 }, 'jump+=0.4')
        .to(tail, { duration: 0.1, y: 50, x: 370, rotation: 35 }, 'jump+=0.4')
        .to(backlegs, { duration: 0.1, rotation: 95, x: 350, y: 5 }, 'jump+=0.4')

        .to(frontlegs, { duration: 0.1, x: 420, y: 205, rotation: -15 }, 'jump+=0.5')
        .to(frontcircle, { duration: 0.1, x: 420, y: 205 }, 'jump+=0.5')
        .to(backcircle, { duration: 0.1, y: 160, x: 430 }, 'jump+=0.5')
        .to(
          bodybetween,
          { duration: 0.1, y: 170, x: 460, scaleX: 1, rotation: 35 },
          'jump+=0.5'
        )
        .to([head, eyes, ears], { duration: 0.1, x: 465, y: 225 }, 'jump+=0.5')
        .to(tail, { duration: 0.1, y: 150, x: 450, rotation: 35 }, 'jump+=0.5')
        .to(backlegs, { duration: 0.1, rotation: 95, x: 430, y: 95 }, 'jump+=0.5')

        .to(cat, { duration: 0.5, opacity: 0 }, 'jump+=0.3')

      // Cat blinking
      tl_eye
        .addLabel('twinkall')
        .to(eyel, { duration: 0.1, scaleY: 0.1, y: 55 }, 'twinkall')
        .to(eyel, { duration: 0.1, scaleY: 1, y: 45 }, 'twinkall +=0.1')
        .to(eyer, { duration: 0.1, scaleY: 0.1, y: 55 }, 'twinkall')
        .to(eyer, { duration: 0.1, scaleY: 1, y: 45 }, 'twinkall +=0.1')
    }

    function finishAnimation() {
      if (logofix) logofix.classList.add('visible')

      // Marquer comme vu
      localStorage.setItem('catAnimationSeen', 'true')
      document.documentElement.classList.add('cat-seen')

      // Faire disparaître le wrapper
      gsap.to(wrapper, {
        duration: 0.5,
        opacity: 0,
        delay: 1,
        onComplete: () => {
          if (wrapper) wrapper.style.display = 'none'
        },
      })
    }

    initAni()
  })
</script>
