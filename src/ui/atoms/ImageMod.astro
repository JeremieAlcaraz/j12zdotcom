---
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'

interface Props {
  /** Exemple : "images/hero" (sans extension) ou "images/hero.png" */
  src: string
  alt: string
  width: number
  height: number
  loading?: 'eager' | 'lazy'
  decoding?: 'async' | 'auto' | 'sync'
  /** Format de sortie demandé à astro:assets (pas le format source) */
  format?: 'auto' | 'avif' | 'jpeg' | 'png' | 'svg' | 'webp'
  class?: string
  style?: string
  /**
   * Ordre de préférence des extensions source (sans impact sur 'format').
   * Par défaut ['avif', 'webp'] et PNG en dernier recours si allowPngFallback=true.
   */
  preferSrc?: ('avif' | 'webp' | 'png')[]
  /** Inclure automatiquement 'png' comme fallback ultime si la source sans extension est fournie. */
  allowPngFallback?: boolean
}

const {
  src: rawSrc,
  alt,
  width,
  height,
  loading = 'lazy',
  decoding = 'auto',
  class: className,
  format = 'auto',
  style,
  preferSrc = ['avif', 'webp'],
  allowPngFallback = true,
} = Astro.props as Props

const imageFormat = format === 'auto' ? undefined : format

/* 1️⃣  Normaliser le chemin fourni */
const normalized = rawSrc.startsWith('/') ? rawSrc : `/${rawSrc}`
/* 2️⃣  Construire la base (sans /src/assets) */
const basePath = normalized.startsWith('/src/assets')
  ? normalized.replace('/src/assets', '')
  : normalized
/* 3️⃣  Import dynamique de toutes les images sous src/assets/ */
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/**/*.{jpeg,jpg,png,gif,webp,avif}'
)

/* 4️⃣  Résolution de l'extension source (priorité: preferSrc, puis png si autorisé) */
const hasExt = /\.[a-zA-Z0-9]+$/.test(basePath)
let resolvedKey: string | null = null
if (hasExt) {
  const key = `/src/assets${basePath}`
  if (images[key]) resolvedKey = key
} else {
  const order = [...preferSrc]
  if (allowPngFallback && !order.includes('png')) order.push('png')
  for (const ext of order) {
    const key = `/src/assets${basePath}.${ext}`
    if (images[key]) { resolvedKey = key; break }
  }
}

/* 5️⃣  Vérification et log dev convivial */
const isValid = !!resolvedKey
if (!isValid) {
  const tried = hasExt ? basePath : `${basePath}.{${[...preferSrc, allowPngFallback ? 'png' : ''].filter(Boolean).join(',')}}`
  console.error(`\x1b[31mImage not found – /src/assets${tried}. Place it under src/assets.\x1b[0m`)
}
---

{
  isValid && resolvedKey && (
    <Image
      src={images[resolvedKey]() as Promise<{ default: ImageMetadata }>}
      alt={alt}
      width={width}
      height={height}
      loading={loading}
      decoding={decoding}
      class={className}
      format={imageFormat}
      style={style}
    />
  )
}
