---
// Composant MusicPlayer - Lecteur de musique avec logique
---

<div class="card bg-base-100 card-border border-base-300 card-sm overflow-hidden">
  <!-- Élément audio caché -->
  <audio id="audio-player" preload="metadata">
    <source src="/musics/jeremie-theme.mp3" type="audio/mpeg" />
    Votre navigateur ne supporte pas l'élément audio.
  </audio>
  <div class="card-body my-2">
    <div class="flex items-center justify-around">
      <button
        class="btn btn-square btn-neutral"
        data-action="prev"
        aria-label="Previous track"
        title="Previous track"
      >
        <i-lucide-skip-back class="size-4 shrink-0"></i-lucide-skip-back>
      </button>
      <button
        class="btn btn-square btn-neutral btn-lg"
        data-action="play"
        aria-label="Play"
        title="Play"
      >
        <i-lucide-play class="icon-play size-6 shrink-0"></i-lucide-play>
        <i-lucide-pause class="icon-pause hidden size-6 shrink-0"></i-lucide-pause>
      </button>
      <button
        class="btn btn-square btn-neutral"
        data-action="next"
        aria-label="Next track"
        title="Next track"
      >
        <i-lucide-skip-forward class="size-4 shrink-0"></i-lucide-skip-forward>
      </button>
    </div>
    <div class="mt-2 text-center">
      <h6 class="text-sm font-bold">PM Zoomcall ASMR</h6>
      <p class="text-xs opacity-50">Project Manager talking for 2 hours</p>
    </div>
  </div>
  <div class="border-base-300 flex flex-col border-t px-6 py-4">
    <div class="relative mt-6">
      <div
        class="tooltip tooltip-open absolute top-2 before:text-xs"
        style="inset-inline-start:10%"
        data-tip="13:39"
      >
      </div>
      <progress class="progress" value="0" max="100"></progress>
    </div>
    <div class="flex justify-between text-xs opacity-50">
      <span data-time="current">13:39</span>
      <span data-time="duration">120:00</span>
    </div>
  </div>
  <div class="flex items-center justify-around px-2 pb-6">
    <button class="btn btn-square btn-volume" data-action="volume" aria-label="Mute" title="Mute">
      <i-lucide-volume-2 class="icon-volume size-4"></i-lucide-volume-2>
      <i-lucide-volume-x class="icon-mute hidden size-4"></i-lucide-volume-x>
    </button>
    <button
      class="btn btn-square btn-shuffle"
      data-action="shuffle"
      aria-label="Shuffle"
      title="Shuffle"
    >
      <i-lucide-shuffle class="size-4"></i-lucide-shuffle>
    </button>
    <button
      class="btn btn-square btn-repeat"
      data-action="repeat"
      aria-label="Repeat"
      title="Repeat"
    >
      <i-lucide-repeat class="size-4"></i-lucide-repeat>
    </button>
    <button class="btn btn-square" aria-label="Headphones" title="Headphones">
      <i-lucide-headphones class="size-4"></i-lucide-headphones>
    </button>
  </div>
</div>

<script type="module">
  class MusicPlayer {
    constructor() {
      this.audio = document.getElementById('audio-player')
      this.playBtn = document.querySelector('[data-action="play"]')
      this.prevBtn = document.querySelector('[data-action="prev"]')
      this.nextBtn = document.querySelector('[data-action="next"]')
      this.volumeBtn = document.querySelector('[data-action="volume"]')
      this.repeatBtn = document.querySelector('[data-action="repeat"]')
      this.shuffleBtn = document.querySelector('[data-action="shuffle"]')
      this.progressBar = document.querySelector('.progress')
      const progressEl = document.querySelector('.progress')
      this.progressContainer = progressEl ? progressEl.parentElement : null
      this.currentTimeEl = document.querySelector('[data-time="current"]')
      this.durationEl = document.querySelector('[data-time="duration"]')
      this.tooltip = document.querySelector('.tooltip')

      this.isPlaying = false
      this.isMuted = false
      this.isRepeating = false
      this.isShuffling = false
      this.volume = 1

      this.init()
    }

    init() {
      this.setupEventListeners()
      this.updateDuration()
      this.updateVolumeButton()
      this.updateRepeatButton()
      this.updateShuffleButton()
    }

    setupEventListeners() {
      this.playBtn?.addEventListener('click', () => this.togglePlay())
      this.prevBtn?.addEventListener('click', () => this.prevTrack())
      this.nextBtn?.addEventListener('click', () => this.nextTrack())
      this.volumeBtn?.addEventListener('click', () => this.toggleMute())
      this.repeatBtn?.addEventListener('click', () => this.toggleRepeat())
      this.shuffleBtn?.addEventListener('click', () => this.toggleShuffle())

      this.progressContainer?.addEventListener('click', e => this.seek(e))

      this.audio.addEventListener('timeupdate', () => this.updateProgress())
      this.audio.addEventListener('loadedmetadata', () => this.updateDuration())
      this.audio.addEventListener('ended', () => this.handleTrackEnd())
      this.audio.addEventListener('play', () => {
        this.isPlaying = true
        this.updatePlayButton(true)
      })
      this.audio.addEventListener('pause', () => {
        this.isPlaying = false
        this.updatePlayButton(false)
      })
    }

    togglePlay() {
      if (this.isPlaying) {
        this.audio.pause()
      } else {
        this.audio.play()
      }
    }

    prevTrack() {
      this.audio.currentTime = 0
    }

    nextTrack() {
      this.audio.currentTime = 0
    }

    toggleMute() {
      this.isMuted = !this.isMuted
      this.audio.muted = this.isMuted
      this.updateVolumeButton()
    }

    toggleRepeat() {
      this.isRepeating = !this.isRepeating
      this.audio.loop = this.isRepeating
      this.updateRepeatButton()
    }

    toggleShuffle() {
      this.isShuffling = !this.isShuffling
      this.updateShuffleButton()
    }

    seek(e) {
      if (!this.progressContainer || isNaN(this.audio.duration)) return
      const rect = this.progressContainer.getBoundingClientRect()
      const percent = (e.clientX - rect.left) / rect.width
      this.audio.currentTime = percent * this.audio.duration
    }

    updateProgress() {
      const percent = (this.audio.currentTime / this.audio.duration) * 100
      if (!isFinite(percent)) return
      if (this.progressBar) this.progressBar.value = percent
      if (this.tooltip) {
        const p = (this.audio.currentTime / this.audio.duration) * 100
        this.tooltip.style.left = `${p}%`
        this.tooltip.setAttribute('data-tip', this.formatTime(this.audio.currentTime))
      }
      if (this.currentTimeEl)
        this.currentTimeEl.textContent = this.formatTime(this.audio.currentTime)
    }

    updateDuration() {
      if (this.durationEl && !isNaN(this.audio.duration)) {
        this.durationEl.textContent = this.formatTime(this.audio.duration)
      }
    }

    handleTrackEnd() {
      if (!this.isRepeating) this.updatePlayButton(false)
    }

    updatePlayButton(isPlaying) {
      const playIcon = this.playBtn?.querySelector('.icon-play')
      const pauseIcon = this.playBtn?.querySelector('.icon-pause')
      if (playIcon && pauseIcon) {
        playIcon.classList.toggle('hidden', isPlaying)
        pauseIcon.classList.toggle('hidden', !isPlaying)
      }
      this.playBtn?.setAttribute('aria-label', isPlaying ? 'Pause' : 'Play')
      this.playBtn?.setAttribute('title', isPlaying ? 'Pause' : 'Play')
    }

    updateVolumeButton() {
      const volumeIcon = this.volumeBtn?.querySelector('.icon-volume')
      const muteIcon = this.volumeBtn?.querySelector('.icon-mute')
      if (volumeIcon && muteIcon) {
        volumeIcon.classList.toggle('hidden', this.isMuted)
        muteIcon.classList.toggle('hidden', !this.isMuted)
      }
      this.volumeBtn?.classList.toggle('bg-primary', this.isMuted)
      this.volumeBtn?.setAttribute('aria-label', this.isMuted ? 'Unmute' : 'Mute')
      this.volumeBtn?.setAttribute('title', this.isMuted ? 'Unmute' : 'Mute')
    }

    updateRepeatButton() {
      this.repeatBtn?.classList.toggle('bg-primary', this.isRepeating)
    }

    updateShuffleButton() {
      this.shuffleBtn?.classList.toggle('bg-primary', this.isShuffling)
    }

    formatTime(seconds) {
      if (isNaN(seconds)) return '0:00'
      const mins = Math.floor(seconds / 60)
      const secs = Math.floor(seconds % 60)
        .toString()
        .padStart(2, '0')
      return `${mins}:${secs}`
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    new MusicPlayer()
  })
</script>
