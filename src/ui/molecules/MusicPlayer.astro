---
// Composant MusicPlayer - Lecteur de musique avec logique
import Icon from '@/ui/atoms/Icon.astro'
---
 

<div class="card bg-base-200 card-border border-base-300 card-sm overflow-hidden shadow-xl ring-1 ring-base-300/40">
  <!-- Élément audio caché -->
  <audio id="audio-player" preload="metadata">
    <source src="/musics/jeremie-theme.mp3" type="audio/mpeg">
    Votre navigateur ne supporte pas l'élément audio.
  </audio>
  <div class="card-body my-2">
    <div class="flex items-center justify-around">
      <button class="btn btn-square btn-neutral" data-action="prev" title="Précédent">
        <Icon name="heroicons:backward" class="size-4 shrink-0" title="Précédent" />
      </button>
      <button class="btn btn-square btn-primary btn-lg" data-action="play" title="Lecture/Pause">
        <span class="relative inline-flex items-center justify-center">
          <Icon name="heroicons:play" class="size-6 shrink-0" data-icon="play" title="Lecture" />
          <Icon name="heroicons:pause" class="size-6 shrink-0" data-icon="pause" title="Pause" hidden />
        </span>
      </button>
      <button class="btn btn-square btn-neutral" data-action="next" title="Suivant">
        <Icon name="heroicons:forward" class="size-4 shrink-0" title="Suivant" />
      </button>
    </div>
    <div class="mt-2 text-center">
      <h6 class="text-sm font-bold">PM Zoomcall ASMR</h6>
      <p class="text-xs opacity-50">Project Manager talking for 2 hours</p>
    </div>
  </div>
  <div class="border-base-300 flex flex-col border-t px-6 py-4">
    <div class="relative mt-6">
      <div
        class="tooltip tooltip-open absolute top-2 before:text-xs"
        style="inset-inline-start:0%"
        data-tip="0:00"
      ></div>
      <progress class="progress progress-primary" value="0" max="100"></progress>
    </div>
    <div class="flex justify-between text-xs opacity-70">
      <span data-time="current">0:00</span>
      <span data-time="duration">4:00</span>
    </div>
  </div>
  <div class="flex items-center justify-around px-2 pb-6">
    <button class="btn btn-square btn-neutral btn-volume" data-action="volume" title="Volume" aria-pressed="false">
      <span class="relative inline-flex items-center justify-center">
        <Icon name="heroicons:speaker-wave" class="size-4" data-icon="volume-on" title="Volume activé" />
        <Icon name="heroicons:speaker-x-mark" class="size-4" data-icon="volume-off" title="Sourdine" hidden />
      </span>
    </button>
    <button class="btn btn-square btn-neutral btn-shuffle" data-action="shuffle" title="Aléatoire" aria-pressed="false">
      <Icon name="heroicons:arrows-right-left" class="size-4" title="Aléatoire" />
    </button>
    <button class="btn btn-square btn-neutral btn-repeat" data-action="repeat" title="Répéter" aria-pressed="false">
      <Icon name="heroicons:arrow-path" class="size-4" title="Répéter" />
    </button>
    <button class="btn btn-square btn-neutral" title="Radio">
      <Icon name="heroicons:rss" class="size-4" title="Radio" />
    </button>
  </div>
</div>

<script>
  class MusicPlayer {
    audio: HTMLAudioElement;
    playBtn: HTMLElement | null;
    prevBtn: HTMLElement | null;
    nextBtn: HTMLElement | null;
    volumeBtn: HTMLElement | null;
    repeatBtn: HTMLElement | null;
    shuffleBtn: HTMLElement | null;
    progressBar: HTMLElement | null;
    progressContainer: HTMLElement | null;
    currentTimeEl: HTMLElement | null;
    durationEl: HTMLElement | null;
    tooltip: HTMLElement | null;
    isPlaying: boolean;
    isMuted: boolean;
    isRepeating: boolean;
    isShuffling: boolean;
    volume: number;
    defaultDurationSec: number;
    constructor() {
      this.audio = document.getElementById('audio-player') as HTMLAudioElement;
      this.playBtn = document.querySelector('[data-action="play"]');
      this.prevBtn = document.querySelector('[data-action="prev"]');
      this.nextBtn = document.querySelector('[data-action="next"]');
      this.volumeBtn = document.querySelector('[data-action="volume"]');
      this.repeatBtn = document.querySelector('[data-action="repeat"]');
      this.shuffleBtn = document.querySelector('[data-action="shuffle"]');
      this.progressBar = document.querySelector('.progress');
      const progressEl = document.querySelector('.progress');
      this.progressContainer = progressEl ? progressEl.parentElement : null;
      this.currentTimeEl = document.querySelector('[data-time="current"]');
      this.durationEl = document.querySelector('[data-time="duration"]');
      this.tooltip = document.querySelector('.tooltip');

      this.isPlaying = false;
      this.isMuted = false;
      this.isRepeating = false;
      this.isShuffling = false;
      this.volume = 1;
      this.defaultDurationSec = 240; // 4 minutes par défaut

      this.init();
    }

    init() {
      this.setupEventListeners();
      this.setInitialUI();
      this.updateDuration();
      this.updateVolumeButton();
      this.updateRepeatButton();
      this.updateShuffleButton();
    }

    setInitialUI() {
      // Remet les éléments UI à l'état initial
      this.audio.currentTime = 0;
      if (this.progressBar) {
        (this.progressBar as HTMLProgressElement).value = 0;
      }
      if (this.tooltip) {
        this.tooltip.style.left = '0%';
        this.tooltip.setAttribute('data-tip', this.formatTime(0));
      }
      if (this.currentTimeEl) {
        this.currentTimeEl.textContent = this.formatTime(0);
      }
      if (this.durationEl) {
        const seconds = isNaN(this.audio.duration) ? this.defaultDurationSec : this.audio.duration;
        this.durationEl.textContent = this.formatTime(seconds);
      }
    }

    setupEventListeners() {
      // Boutons de contrôle
      if (this.playBtn) {
        this.playBtn.addEventListener('click', () => this.togglePlay());
      }
      if (this.prevBtn) {
        this.prevBtn.addEventListener('click', () => this.prevTrack());
      }
      if (this.nextBtn) {
        this.nextBtn.addEventListener('click', () => this.nextTrack());
      }
      if (this.volumeBtn) {
        this.volumeBtn.addEventListener('click', () => this.toggleMute());
      }
      if (this.repeatBtn) {
        this.repeatBtn.addEventListener('click', () => this.toggleRepeat());
      }
      if (this.shuffleBtn) {
        this.shuffleBtn.addEventListener('click', () => this.toggleShuffle());
      }

      // Barre de progression
      if (this.progressContainer) {
        this.progressContainer.addEventListener('click', (e) => this.seek(e));
      }

      // Événements audio
      this.audio.addEventListener('timeupdate', () => this.updateProgress());
      this.audio.addEventListener('loadedmetadata', () => this.updateDuration());
      this.audio.addEventListener('ended', () => this.handleTrackEnd());
      this.audio.addEventListener('play', () => this.updatePlayButton(true));
      this.audio.addEventListener('pause', () => this.updatePlayButton(false));
    }

    togglePlay() {
      if (this.isPlaying) {
        this.audio.pause();
      } else {
        this.audio.play();
      }
      this.isPlaying = !this.isPlaying;
    }

    prevTrack() {
      // Pour l'instant, recommence la piste
      this.audio.currentTime = 0;
    }

    nextTrack() {
      // Pour l'instant, recommence la piste
      this.audio.currentTime = 0;
    }

    toggleMute() {
      this.isMuted = !this.isMuted;
      this.audio.muted = this.isMuted;
      this.updateVolumeButton();
    }

    toggleRepeat() {
      this.isRepeating = !this.isRepeating;
      this.audio.loop = this.isRepeating;
      this.updateRepeatButton();
    }

    toggleShuffle() {
      this.isShuffling = !this.isShuffling;
      this.updateShuffleButton();
    }

    seek(e: MouseEvent) {
      if (!this.progressContainer) return;
      const rect = this.progressContainer.getBoundingClientRect();
      const percent = (e.clientX - rect.left) / rect.width;
      this.audio.currentTime = percent * this.audio.duration;
    }

    updateProgress() {
      const percent = (this.audio.currentTime / this.audio.duration) * 100;
      if (this.progressBar) {
        (this.progressBar as HTMLProgressElement).value = percent;
      }

      // Mettre à jour le tooltip
      if (this.tooltip) {
        const tooltipPercent = (this.audio.currentTime / this.audio.duration) * 100;
        this.tooltip.style.left = `${tooltipPercent}%`;
        this.tooltip.setAttribute('data-tip', this.formatTime(this.audio.currentTime));
      }

      // Mettre à jour le temps actuel
      if (this.currentTimeEl) {
        this.currentTimeEl.textContent = this.formatTime(this.audio.currentTime);
      }
    }

    updateDuration() {
      if (!this.durationEl) return;
      const seconds = isNaN(this.audio.duration) ? this.defaultDurationSec : this.audio.duration;
      this.durationEl.textContent = this.formatTime(seconds);
    }

    handleTrackEnd() {
      if (!this.isRepeating) {
        this.isPlaying = false;
        this.updatePlayButton(false);
      }
    }

    updatePlayButton(isPlaying: boolean) {
      const playEl = this.playBtn?.querySelector('[data-icon="play"]') as HTMLElement | null;
      const pauseEl = this.playBtn?.querySelector('[data-icon="pause"]') as HTMLElement | null;
      if (playEl && pauseEl) {
        playEl.hidden = isPlaying;
        pauseEl.hidden = !isPlaying;
      }
    }

    updateVolumeButton() {
      if (!this.volumeBtn) return;
      const onEl = this.volumeBtn.querySelector('[data-icon="volume-on"]') as HTMLElement | null;
      const offEl = this.volumeBtn.querySelector('[data-icon="volume-off"]') as HTMLElement | null;
      if (onEl && offEl) {
        onEl.hidden = this.isMuted;
        offEl.hidden = !this.isMuted;
      }
      // Style actif/inactif
      this.volumeBtn.classList.toggle('btn-primary', this.isMuted);
      this.volumeBtn.classList.toggle('btn-neutral', !this.isMuted);
      this.volumeBtn.setAttribute('aria-pressed', String(this.isMuted));
    }

    updateRepeatButton() {
      if (!this.repeatBtn) return;
      this.repeatBtn.classList.toggle('btn-primary', this.isRepeating);
      this.repeatBtn.classList.toggle('btn-neutral', !this.isRepeating);
      this.repeatBtn.setAttribute('aria-pressed', String(this.isRepeating));
    }

    updateShuffleButton() {
      if (!this.shuffleBtn) return;
      this.shuffleBtn.classList.toggle('btn-primary', this.isShuffling);
      this.shuffleBtn.classList.toggle('btn-neutral', !this.isShuffling);
      this.shuffleBtn.setAttribute('aria-pressed', String(this.isShuffling));
    }

    formatTime(seconds: number) {
      if (isNaN(seconds)) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }
  }

  // Initialiser le lecteur quand le DOM est prêt
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => new MusicPlayer());
  } else {
    new MusicPlayer();
  }
</script>
