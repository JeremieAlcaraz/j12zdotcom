---
import Icon from '@/ui/atoms/Icon.astro'

---

<!-- Floating Action Button (FAB) + Speed Dial using daisyUI 5 -->
<div class="fab fixed bottom-6 right-6 z-50">
  <!-- Focusable trigger: required for accessibility and to open the Speed Dial -->
  <div
    tabindex="0"
    role="button"
    aria-label="Actions rapides"
    aria-expanded="false"
    class="btn btn-lg btn-circle btn-secondary"
    data-fab-main
  >
    <!-- Plus icon (inline SVG) -->
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="2"
      stroke="currentColor"
      aria-hidden="true"
      class="size-6"
    >
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
    </svg>
  </div>

  <!-- Buttons that show up when FAB is open -->
  <button type="button" class="btn btn-lg btn-circle" aria-label="Focus" data-fab-item data-fab-action="focus">
    <Icon name="eye" size={24} class="text-base-content" title="Focus" />
  </button>
  <button type="button" class="btn btn-lg btn-circle" aria-label="Musique" data-fab-item data-fab-action="music">
    <Icon name="music" size={24} class="text-base-content" title="Musique" />
  </button>
</div>

<script is:inline>
  (() => {
    // The script is placed right after the .fab element, so we can reliably select it
    const root = (document.currentScript && document.currentScript.previousElementSibling) || null
    if (!root) return
    const main = root.querySelector('[data-fab-main]')
    const items = root.querySelectorAll('[data-fab-item]')
    if (!main) return

    const setExpanded = (val) => {
      main.setAttribute('aria-expanded', val ? 'true' : 'false')
    }

    const open = () => {
      setExpanded(true)
      main.focus()
    }
    const close = () => {
      setExpanded(false)
      // Blur to remove focus-within so daisyUI closes the Speed Dial
      if (document.activeElement === main) {
        main.blur()
      }
    }

    main.addEventListener('click', (e) => {
      e.preventDefault()
      const expanded = main.getAttribute('aria-expanded') === 'true'
      expanded ? close() : open()
    })

    // Close when selecting any menu item and emit a generic event
    items.forEach((btn) => {
      btn.addEventListener('click', () => {
        const action = btn.getAttribute('data-fab-action')
        if (action) {
          // Emit a generic event for domain controllers to handle
          const ev = new CustomEvent('fab:action', {
            detail: { action },
            bubbles: true,
          })
          btn.dispatchEvent(ev)
        }
        close()
      })
    })

    // Close on Escape
    main.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close()
    })

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (!root.contains(e.target)) close()
    })
  })()
</script>
