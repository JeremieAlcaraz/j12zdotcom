---
import type { ImageMetadata } from 'astro'
import { Image } from 'astro:assets'

interface Props {
  /** Exemple : "images/hero.png" ou "/images/hero.png" */
  src: string
  alt: string
  width: number
  height: number
  loading?: 'eager' | 'lazy'
  decoding?: 'async' | 'auto' | 'sync'
  format?: 'auto' | 'avif' | 'jpeg' | 'png' | 'svg' | 'webp'
  class?: string
  style?: string
}

const {
  src: rawSrc,
  alt,
  width,
  height,
  loading = 'lazy',
  decoding = 'auto',
  class: className,
  format = 'auto',
  style,
} = Astro.props

const imageFormat = format === 'auto' ? undefined : format

/* 1️⃣  Normaliser le chemin fourni */
const normalized = rawSrc.startsWith('/') ? rawSrc : `/${rawSrc}`
/* 2️⃣  Construire le chemin absolu attendu par import.meta.glob */
const imageKey = `/src/assets${normalized}`

/* 3️⃣  Import dynamique de toutes les images sous src/assets/ */
const glob = import.meta.glob as <T>(
  pattern: string
) => Record<string, () => Promise<T>>
const images = glob<{ default: ImageMetadata }>(
  '/src/assets/**/*.{jpeg,jpg,png,gif,webp,avif}'
)

/* 4️⃣  Récupération de l'image si elle existe */
let image: ImageMetadata | undefined
if (imageKey in images) {
  const mod = await images[imageKey]()
  image = mod.default
}
---

{
  image && (
    <Image
      src={image}
      alt={alt}
      width={width}
      height={height}
      loading={loading}
      decoding={decoding}
      class={className}
      format={imageFormat}
      style={style}
    />
  )
}
