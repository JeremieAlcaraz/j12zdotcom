---
import astroLogo from '../assets/astro.svg';

const {
  logo = astroLogo.src,
  links = [
    { href: '/', label: 'Accueil' },
    { href: '/about', label: 'À propos' },
    { href: '/blog', label: 'Blog' },
  ],
} = Astro.props;
---

<nav class="navbar bg-base-100 shadow-md">
  <div class="navbar-start">
    <a href="/" class="btn btn-ghost text-xl normal-case">
      <img src={logo} alt="Logo" class="h-8 w-8" />
      <span class="hidden sm:inline ml-2">MonSite</span>
    </a>
  </div>

  <div class="navbar-center hidden lg:flex">
    <ul class="menu menu-horizontal px-1">
      {
        links.map(({ href, label }) => (
          <li>
            <a href={href} class="hover:bg-primary hover:text-primary-content rounded-lg">
              {label}
            </a>
          </li>
        ))
      }
    </ul>
  </div>

  <div class="navbar-end">
    <!-- Bouton de thème simplifié -->
    <button id="theme-toggle" class="btn btn-ghost btn-circle">
      <svg
        id="sun-icon"
        class="w-5 h-5 fill-current"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
      >
        <path
          d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"
        ></path>
      </svg>

      <svg
        id="moon-icon"
        class="w-5 h-5 fill-current hidden"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
      >
        <path
          d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"
        ></path>
      </svg>
    </button>

    <!-- Menu mobile -->
    <div class="dropdown dropdown-end lg:hidden">
      <label tabindex="0" class="btn btn-ghost btn-circle">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-5 w-5"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16M4 12h8m-8 6h16"></path>
        </svg>
      </label>
      <ul
        tabindex="0"
        class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52"
      >
        {
          links.map(({ href, label }) => (
            <li>
              <a href={href}>{label}</a>
            </li>
          ))
        }
      </ul>
    </div>
  </div>
</nav>

<style>
  /* CSS pour les transitions View Transition API */
  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation: none;
    mix-blend-mode: normal;
  }

  ::view-transition-old(root) {
    z-index: 1;
  }

  ::view-transition-new(root) {
    z-index: 999;
  }

  html {
    color-scheme: light;
  }

  html[data-theme='dark'] {
    color-scheme: dark;
  }
</style>

<script>
  // Variables globales
  let isAnimating = false;

  // Fonctions utilitaires
  const isDark = () => document.documentElement.getAttribute('data-theme') === 'dark';

  const updateIcons = (dark: boolean) => {
    const sunIcon = document.getElementById('sun-icon');
    const moonIcon = document.getElementById('moon-icon');

    if (sunIcon && moonIcon) {
      if (dark) {
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
      } else {
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
      }
    }
  };

  const applyTheme = (dark: boolean) => {
    document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
    localStorage.setItem('theme', dark ? 'dark' : 'light');
    updateIcons(dark);
  };

  // Animation principale
  async function toggleThemeWithAnimation(event: MouseEvent) {
    // Empêcher les clics multiples pendant l'animation
    if (isAnimating) return;

    // Vérification du support View Transition
    if (!(document as any).startViewTransition) {
      applyTheme(!isDark());
      return;
    }

    // Vérification des préférences d'animation
    if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
      applyTheme(!isDark());
      return;
    }

    isAnimating = true;

    // Coordonnées du clic
    const { clientX: x, clientY: y } = event;

    // Calcul du rayon pour couvrir l'écran entier
    const endRadius = Math.hypot(
      Math.max(x, window.innerWidth - x),
      Math.max(y, window.innerHeight - y)
    );

    console.log(`Animation démarrée - Position: (${x}, ${y}), Rayon: ${endRadius}`);

    try {
      // Démarrage de la transition
      const transition = (document as any).startViewTransition(async () => {
        applyTheme(!isDark());
      });

      // Attendre que la transition soit prête
      await transition.ready;

      // Configuration de l'animation
      const clipPath = [`circle(0px at ${x}px ${y}px)`, `circle(${endRadius}px at ${x}px ${y}px)`];

      const isDarkNow = isDark();

      // Lancement de l'animation
      const animation = document.documentElement.animate(
        {
          clipPath: isDarkNow ? clipPath.slice().reverse() : clipPath,
        },
        {
          duration: 500,
          easing: 'ease-out',
          pseudoElement: isDarkNow ? '::view-transition-old(root)' : '::view-transition-new(root)',
        }
      );

      // Attendre la fin de l'animation
      await animation.finished;
    } catch (error) {
      console.error("Erreur pendant l'animation:", error);
      // Fallback en cas d'erreur
      applyTheme(!isDark());
    } finally {
      isAnimating = false;
    }
  }

  // Initialisation du thème
  function initTheme() {
    const savedTheme = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const shouldBeDark = savedTheme ? savedTheme === 'dark' : systemPrefersDark;

    applyTheme(shouldBeDark);
  }

  // Configuration des événements
  function setupEventListeners() {
    const themeButton = document.getElementById('theme-toggle');

    if (themeButton) {
      themeButton.addEventListener('click', (event) => {
        event.stopPropagation();
        toggleThemeWithAnimation(event as MouseEvent);
      });
    }

    // Écoute des changements de préférence système
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) {
        applyTheme(e.matches);
      }
    });
  }

  // Initialisation
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      setupEventListeners();
    });
  } else {
    initTheme();
    setupEventListeners();
  }
</script>
