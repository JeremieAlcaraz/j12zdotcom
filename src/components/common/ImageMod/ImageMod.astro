---
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';

interface Props {
  /** Exemple : "images/hero.png" ou "/images/hero.png" */
  src: string;
  alt: string;
  width: number;
  height: number;
  loading?: 'eager' | 'lazy';
  decoding?: 'async' | 'auto' | 'sync';
  format?: 'auto' | 'avif' | 'jpeg' | 'png' | 'svg' | 'webp';
  class?: string;
  style?: string;
}

const {
  src: rawSrc,
  alt,
  width,
  height,
  loading = 'lazy',
  decoding = 'auto',
  class: className,
  format = 'auto',
  style,
} = Astro.props;

/* 1️⃣  Normaliser le chemin fourni */
const normalized = rawSrc.startsWith('/') ? rawSrc : `/${rawSrc}`;
/* 2️⃣  Construire le chemin absolu attendu par import.meta.glob */
const imageKey = `/src/assets${normalized}`;

/* 3️⃣  Import dynamique de toutes les images sous src/assets/ */
const images = import.meta.glob<{ default: ImageMetadata }>(
  '/src/assets/**/*.{jpeg,jpg,png,gif,webp,avif}'
);

/* 4️⃣  Vérification et log dev convivial */
const isValid = !!images[imageKey];
if (!isValid) {
  console.error(`\x1b[31mImage not found – ${imageKey}. Place it under src/assets.\x1b[0m`);
}
---

{
  isValid && (
    <Image
      src={images[imageKey]() as Promise<{ default: ImageMetadata }>}
      alt={alt}
      width={width}
      height={height}
      loading={loading}
      decoding={decoding}
      class={className}
      format={format}
      style={style}
    />
  )
}
