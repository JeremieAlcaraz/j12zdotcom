---
import BaseLayout from '@/layouts/BaseLayout.astro'
import BlogCard from '@/components/domain/blog/BlogCard.astro'
import Pagination from '@ui/molecules/Pagination.astro'
import config from '@/config/siteConfig.ts'
import { sortByDate } from '@utils/sortFunctions'
import { getSinglePage } from '@/utils/contentParser'
import type { CollectionEntry } from 'astro:content'
import { getEntry } from 'astro:content'
import { makePaginationLinks } from '@/utils/pagination'

const COLLECTION = 'blog' // <-- utilisé hors getStaticPaths
const { page: pageParam } = Astro.params

// Page d'index (meta, title, etc.)
const postIndex = (await getEntry(COLLECTION, '-index')) as CollectionEntry<'blog'>

// Récup + tri des posts
const posts = await getSinglePage(COLLECTION)
const sortedPosts = sortByDate(posts)

// Pagination
const perPage = config.settings.pagination
const currentPage = Math.max(1, parseInt(pageParam ?? '1', 10) || 1)
const totalPages = Math.ceil(sortedPosts.length / perPage)
const start = (currentPage - 1) * perPage
const end = start + perPage
const currentPosts = sortedPosts.slice(start, end)

const { pages, prev, next } = makePaginationLinks(COLLECTION, currentPage, totalPages)

// Génération des chemins (param = "page")
export async function getStaticPaths() {
  const COLLECTION_FOLDER = 'blog' // <-- redéclaré ici
  const posts = await getSinglePage(COLLECTION_FOLDER)
  const perPage = config.settings.pagination
  const totalPages = Math.ceil(posts.length / perPage)

  return Array.from({ length: totalPages }, (_, i) => ({
    params: { page: String(i + 1) },
  }))
}
---

<BaseLayout
  title={postIndex.data.title}
  meta_title={postIndex.data.meta_title}
  image={postIndex.data.image}
  description={postIndex.data.description}
>
  <section class="px-4 py-8 sm:py-12 lg:py-16">
    <div class="mx-auto max-w-6xl">
      <div class="flex flex-col gap-8 lg:flex-row">
        <div class="flex-1">
          <div class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 sm:gap-6 xl:grid-cols-3">
            {
              currentPosts.map(post => (
                <div class="w-full">
                  <BlogCard data={post} />
                </div>
              ))
            }
          </div>

          {
            totalPages > 1 && (
              <div class="mt-12 flex justify-center">
                <Pagination pages={pages} prev={prev} next={next} />
              </div>
            )
          }
        </div>
      </div>
    </div>
  </section>
</BaseLayout>
