name: ğŸ§ª Test SSH Connection

on:
  workflow_dispatch:

jobs:
  test-ssh:
    name: Test Tailscale + SSH
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”Œ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: ğŸ“¡ Test network connectivity
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Testing Tailscale network..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          echo ""
          echo "ğŸ” Tailscale status:"
          tailscale status

          echo ""
          echo "ğŸ“ Ping Magnolia (${{ secrets.MAGNOLIA_HOST }}):"
          ping -c 3 ${{ secrets.MAGNOLIA_HOST }}

          echo ""
          echo "ğŸ“ Ping Mimosa (${{ secrets.MIMOSA_HOST }}):"
          ping -c 3 ${{ secrets.MIMOSA_HOST }}

      - name: ğŸ”‘ Setup SSH key
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Setting up SSH key..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Create SSH config for both servers
          cat > ~/.ssh/config << EOF
          Host magnolia
            HostName ${{ secrets.MAGNOLIA_HOST }}
            User jeremie
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new
            IdentitiesOnly yes

          Host mimosa
            HostName ${{ secrets.MIMOSA_HOST }}
            User jeremie
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new
            IdentitiesOnly yes
          EOF

          chmod 600 ~/.ssh/config

          echo ""
          echo "ğŸ“„ SSH key file info:"
          ls -la ~/.ssh/deploy_key

          echo ""
          echo "ğŸ” SSH key fingerprint:"
          ssh-keygen -lf ~/.ssh/deploy_key

          echo ""
          echo "Expected fingerprint: SHA256:X/I4DzZnBJH4FcXps08IGzE+4qfZvwCGxj3aPJgkaAE"

      - name: ğŸ—ï¸ Test SSH to Magnolia (verbose)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Testing SSH to Magnolia..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Redirect stderr to stdout to capture verbose output
          ssh -vvv magnolia "echo 'âœ… Connected to Magnolia!'; echo ''; echo 'Hostname: \$(hostname)'; echo 'User: \$(whoami)'; echo 'NixOS: \$(nixos-version)'" 2>&1 || {
            echo ""
            echo "âŒ SSH connection to Magnolia failed!"
            exit 1
          }

      - name: ğŸŒ¸ Test SSH to Mimosa (verbose)
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Testing SSH to Mimosa..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # Redirect stderr to stdout to capture verbose output
          ssh -vvv mimosa "echo 'âœ… Connected to Mimosa!'; echo ''; echo 'Hostname: \$(hostname)'; echo 'User: \$(whoami)'; echo 'NixOS: \$(nixos-version)'" 2>&1 || {
            echo ""
            echo "âŒ SSH connection to Mimosa failed!"
            exit 1
          }

      - name: âœ… Success
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All tests passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ“ Tailscale connection working"
          echo "âœ“ Network connectivity working"
          echo "âœ“ SSH to Magnolia working"
          echo "âœ“ SSH to Mimosa working"
          echo ""
          echo "ğŸš€ Ready for automated deployments!"
