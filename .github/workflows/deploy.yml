name: ðŸš€ Deploy jeremiealcaraz.com

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”Œ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: ðŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          cat > ~/.ssh/config << EOF
          Host magnolia
            HostName ${{ secrets.MAGNOLIA_HOST }}
            User jeremie
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new
            IdentitiesOnly yes

          Host mimosa
            HostName ${{ secrets.MIMOSA_HOST }}
            User jeremie
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new
            IdentitiesOnly yes
          EOF

          chmod 600 ~/.ssh/config

      - name: ðŸ—ï¸ Build on Magnolia and push flake.lock
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ—ï¸ Building jeremiealcaraz.com on Magnolia..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          ssh magnolia bash << 'ENDSSH'
            set -e

            echo "ðŸ“ Current location: $(hostname)"
            echo "ðŸ‘¤ Running as: $(whoami)"
            echo ""

            echo "ðŸ”„ Syncing config from GitHub..."
            cd /etc/nixos
            git fetch --all
            git reset --hard origin/main

            echo "ðŸ“¦ Updating j12z-site flake input..."
            nix flake update j12z-site

            echo ""
            echo "ðŸ”¨ Building magnolia configuration..."
            sudo nixos-rebuild switch --flake .#magnolia

            echo ""
            echo "ðŸ“¤ Committing and pushing flake.lock to GitHub..."

            if git diff --quiet flake.lock; then
              echo "â„¹ï¸  No changes to flake.lock, skipping commit"
            else
              git add flake.lock
              git commit -m "chore: update flake.lock after j12z-site build"
              git push origin main
              echo "âœ… flake.lock pushed to GitHub"
            fi

            echo ""
            echo "âœ… Build complete! Binary cache updated."
          ENDSSH

      - name: ðŸŒ¸ Deploy on Mimosa
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŒ¸ Deploying to Mimosa..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          ssh mimosa bash << 'ENDSSH'
            set -e

            echo "ðŸ“ Current location: $(hostname)"
            echo "ðŸ‘¤ Running as: $(whoami)"
            echo ""

            echo "ðŸ”„ Syncing config from GitHub (hard reset)..."
            cd /etc/nixos
            git fetch --all
            git reset --hard origin/main

            echo ""
            echo "ðŸš€ Deploying mimosa configuration..."
            sudo nixos-rebuild switch --flake .#mimosa

            echo ""
            echo "âœ… Deployment complete!"
          ENDSSH

      - name: ðŸŒ Purge Cloudflare cache
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŒ Purging Cloudflare cache..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' \
            --fail \
            --show-error \
            --silent | jq '.'

          echo ""
          echo "âœ… Cloudflare cache purged!"

      - name: âœ… Deployment successful
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸŽ‰ jeremiealcaraz.com has been updated!"
          echo "ðŸŒ Visit: https://jeremiealcaraz.com"
          echo ""

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please check the logs above for details."
          exit 1
