name: ğŸš€ Deploy jeremiealcaraz.com

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ”Œ Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:github-actions

      - name: ğŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          cat > ~/.ssh/config << EOF
          Host magnolia
            HostName ${{ secrets.MAGNOLIA_HOST }}
            User jeremie
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new
            IdentitiesOnly yes
          Host mimosa
            HostName ${{ secrets.MIMOSA_HOST }}
            User jeremie
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking accept-new
            IdentitiesOnly yes
          EOF
          chmod 600 ~/.ssh/config
      - name: ğŸ•µï¸ Debug SSH Key Format
        run: |
          echo "ğŸ“Š Nombre de lignes dans la clÃ© (devrait Ãªtre > 1) :"
          wc -l ~/.ssh/deploy_key
          echo "ğŸ§ PremiÃ¨re ligne (devrait Ãªtre -----BEGIN...) :"
          head -n 1 ~/.ssh/deploy_key

      - name: ğŸ—ï¸ Build on Magnolia and push flake.lock
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ—ï¸ Building jeremiealcaraz.com on Magnolia..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          ssh magnolia bash << 'ENDSSH'
            set -e
            echo "ğŸ“ Current location: $(hostname)"
            echo "ğŸ‘¤ Running as: $(whoami)"
            echo ""
            echo "ğŸ”„ Syncing config from GitHub..."
            cd /etc/nixos
            git fetch --all
            git reset --hard origin/main
            echo "ğŸ“¦ Updating j12z-site flake input..."
            nix flake update j12z-site
            echo ""
            echo "ğŸ—ï¸ Building Mimosa configuration (for binary cache)..."
            nix build .#nixosConfigurations.mimosa.config.system.build.toplevel
            echo ""
            echo "ğŸ”¨ Building Magnolia configuration..."
            sudo nixos-rebuild switch --flake .#magnolia
            echo ""
            echo "ğŸ“¤ Committing and pushing flake.lock to GitHub..."
            if git diff --quiet flake.lock; then
              echo "â„¹ï¸  No changes to flake.lock, skipping commit"
            else
              git add flake.lock
              git commit -m "chore: update flake.lock after j12z-site build"
              git push origin main
              echo "âœ… flake.lock pushed to GitHub"
            fi
            echo ""
            echo "âœ… Build complete! Binary cache updated."
          ENDSSH

      - name: ğŸŒ¸ Deploy on Mimosa
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ¸ Deploying to Mimosa..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          ssh mimosa bash << 'ENDSSH'
            set -e
            echo "ğŸ“ Current location: $(hostname)"
            echo "ğŸ‘¤ Running as: $(whoami)"
            echo ""
            echo "ğŸ”„ Syncing config from GitHub (hard reset)..."
            cd /etc/nixos
            git fetch --all
            git reset --hard origin/main
            echo ""
            echo "ğŸš€ Deploying mimosa configuration..."
            sudo nixos-rebuild switch --flake .#mimosa
            echo ""
            echo "âœ… Deployment complete!"
          ENDSSH

      - name: ğŸŒ Purge Cloudflare cache
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Purging Cloudflare cache..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          curl -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CLOUDFLARE_ZONE_ID }}/purge_cache" \
            -H "Authorization: Bearer ${{ secrets.CLOUDFLARE_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            --data '{"purge_everything":true}' \
            --fail \
            --show-error \
            --silent | jq '.'
          echo ""
          echo "âœ… Cloudflare cache purged!"

      - name: âœ… Deployment successful
        if: success()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Deployment successful!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ‰ jeremiealcaraz.com has been updated!"
          echo "ğŸŒ Visit: https://jeremiealcaraz.com"
          echo ""

      - name: âŒ Deployment failed
        if: failure()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ Deployment failed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Please check the logs above for details."
          exit 1
