# Caddyfile - Configuration du reverse proxy Caddy

{
	# Email pour éventuels certificats (pas utilisé ici pour ce site derrière Cloudflare Tunnel)
	email hellow@jeremiealcaraz.com

	log {
		output file /var/log/caddy/access.log
		format json
	}
}

# IMPORTANT :
# On met explicitement http:// pour éviter l'auto HTTPS de Caddy
http://jeremiealcaraz.com, http://www.jeremiealcaraz.com {
	# Reverse proxy vers Astro dev dans Docker
	reverse_proxy j12z_astro_dev:4321 {
		header_up X-Real-IP {remote_host}
		header_up X-Forwarded-For {remote_host}
		header_up X-Forwarded-Proto {scheme}
		header_up X-Forwarded-Host {host}
	}

	encode gzip zstd

	header {
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: https:; font-src 'self' data: https:; frame-src 'self' https:; connect-src 'self' https:;"
		Permissions-Policy "geolocation=(), microphone=(), camera=()"
		-Server
	}

	handle_errors {
		@404 {
			expression {http.error.status_code} == 404
		}
		rewrite @404 /404.html
		file_server
	}

	log {
		output file /var/log/caddy/jeremiealcaraz.log {
			roll_size 100mb
			roll_keep 10
			roll_keep_for 720h
		}
		format json
		level INFO
	}
}
